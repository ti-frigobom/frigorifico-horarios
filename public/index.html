<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Painel de Produção</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { background-color: #020617; color: white; height: 100vh; margin: 0; overflow: hidden; display: flex; flex-direction: column; }
        .card-normal { background: #1e293b; border-left: 15px solid #22c55e; }
        .card-atencao { background: #450a0a; border-left: 15px solid #ef4444; animation: pulse 2s infinite; }
        @keyframes pulse { 0% { transform: scale(1); } 50% { transform: scale(1.02); } 100% { transform: scale(1); } }
        #grid-setores {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
            gap: 20px; padding: 25px; flex-grow: 1; align-content: start;
        }
    </style>
</head>
<body>

    <header class="py-8 bg-slate-900 border-b border-slate-800 shadow-2xl">
        <h1 id="titulo-principal" class="text-5xl md:text-6xl font-black text-center uppercase tracking-tighter">
            HORÁRIOS DA PRODUÇÃO
        </h1>
    </header>

    <div id="grid-setores"></div>

    <footer class="bg-slate-900 p-6 border-t border-slate-800 flex justify-center gap-12">
        <div class="flex items-center gap-4">
            <div class="w-8 h-8 bg-green-500 rounded shadow-lg"></div>
            <span class="text-2xl font-black uppercase text-slate-300 italic">Em Operação</span>
        </div>
        <div class="flex items-center gap-4">
            <div class="w-8 h-8 bg-red-500 rounded shadow-lg"></div>
            <span class="text-2xl font-black uppercase text-slate-300 italic">Fim de Turno</span>
        </div>
    </footer>

    <script>
        function verificarAtenção(horarioString) {
            try {
                const horaFimStr = horarioString.split('-')[1].trim(); 
                const [h, m] = horaFimStr.split(':').map(Number);
                const agora = new Date();
                return (agora.getHours() * 60 + agora.getMinutes()) >= (h * 60 + m);
            } catch (e) { return false; }
        }

        async function carregarDados() {
            try {
                // 1. Atualiza Data no Título
                const resData = await fetch('/api/config/data');
                const dataJson = await resData.json();
                if (dataJson.valor) {
                    const d = new Date(dataJson.valor);
                    d.setMinutes(d.getMinutes() + d.getTimezoneOffset());
                    const dataFmt = d.toLocaleDateString('pt-BR', { day: '2-digit', month: '2-digit', year: 'numeric' });
                    document.getElementById('titulo-principal').innerText = `HORÁRIOS DA PRODUÇÃO - ${dataFmt}`;
                }

                // 2. Atualiza Grid de Setores
                const resSetores = await fetch('/api/setores');
                const setores = await resSetores.json();
                const container = document.getElementById('grid-setores');
                
                container.innerHTML = setores.map(s => {
                    const atencao = verificarAtenção(s.horario);
                    return `
                        <div class="${atencao ? 'card-atencao' : 'card-normal'} p-8 rounded-2xl flex flex-col justify-center items-center">
                            <span class="text-slate-400 uppercase text-3xl font-black mb-3 text-center">${s.nome}</span>
                            <span class="text-6xl md:text-7xl font-mono font-black text-yellow-400 drop-shadow-2xl">${s.horario}</span>
                            ${atencao ? '<span class="text-red-400 text-lg font-black mt-4 animate-bounce">ENCERRADO</span>' : ''}
                        </div>`;
                }).join('');
            } catch (err) { console.error(err); }
        }

        carregarDados();
        setInterval(carregarDados, 30000); 
        setTimeout(() => window.location.reload(), 3600000);
    </script>
</body>
</html>